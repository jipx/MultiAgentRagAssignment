# ğŸ“¦ Multi-Agent RAG System (AWS CDK Deployment)

This project sets up a multi-agent Retrieval-Augmented Generation (RAG) architecture on AWS using the AWS CDK (Python). It includes secure ingestion of questions via API Gateway, processing via Lambda functions, Bedrock inference integration, and storage of answers in DynamoDB.

## ğŸš€ Architecture Components

[![Watch the 3 miniute video on YouTube](https://img.youtube.com/vi/cNqzzDHiTxs/0.jpg)](https://www.youtube.com/watch?v=cNqzzDHiTxs)

- **API Gateway**: Provides three endpoints:
  - `POST /ask`: Submit a question (with throttling settings)
  - `GET /get-answer`: Retrieve answer by `request_id`
  - `GET /history`: Retrieve all past answers by a user
- **Lambda Functions**:
  - `SubmitLambda`: Sends user question to SQS
  - `WorkerLambda`: Routes question to relevant agent (e.g., OWASP agent), talks to Bedrock, saves to DynamoDB
  - `GetAnswerLambda`: Fetches individual answer
  - `GetHistoryLambda`: Fetches answer history for a user
- **SQS Queues**:
  - Main queue: `RAGQueryQueue`
  - Dead Letter Queue: `RAGWorkerDLQ`
- **DynamoDB**: `ResponseTable` stores answers keyed by `request_id`
- **CloudWatch**: DLQ alarm if messages are stuck

## ğŸ” Environment Variables

Ensure the following environment values are provided (via `cdk.context.json` or CLI):

```json
{
  "account": "<your_account_id>",
  "region": "ap-southeast-1",
  "model_name": "Claude",
  "model_id": "anthropic.claude-v2",
  "kb_id": "owasp-kb-001",
  "rag_endpoint_url": "https://bedrock-runtime.ap-southeast-1.amazonaws.com"
}
```

## â±ï¸ API Rate Limiting (Throttling)

API Gateway throttling is configured for the `POST /ask` endpoint (suggested to be done via Usage Plans):

- **Rate Limit**: 5 requests per second
- **Burst Limit**: 2

ğŸ’¡ Create an **API Key + Usage Plan** in console or CDK for stricter enforcement.

## ğŸ§ª Sample Test Case: Ask API (Postman)
```json
POST /ask
{
  "question": "What is SQL Injection?",
  "user_id": "student123",
  "topic": "secure coding"
}
```

## ğŸ§ª Sample Test Case: SQS Worker Input
```json
{
  "request_id": "abc123",
  "user_id": "student123",
  "question": "Explain XSS with example.",
  "topic": "secure coding",
  "timestamp": "2025-10-10T12:00:00Z"
}
```

## ğŸ“ˆ Load Simulation / Throttling Test (Postman Runner or Artillery)
Use a tool like [Artillery](https://artillery.io/) or Postman Runner to simulate concurrent requests to `POST /ask`. Observe throttling responses (`429`) if limits exceeded.

## ğŸ› ï¸ Troubleshooting

- **ValidationException**: Ensure `request_id` is the key in DynamoDB, not `question_id`
- **Bedrock Errors**: Double-check `model_id`, and that you use the correct Bedrock API type (Text vs. Messages)
- **Lambda DLQ alerts**: Check CloudWatch logs and queue metrics

## âœ… Best Practices

- âœ… Environment-based configuration (`cdk.context.json`)
- âœ… DLQ and monitoring via CloudWatch
- âœ… Secure API with throttling and optional API keys
- âœ… Modular agent orchestration

---

ğŸ“š *Generated by CDK and enhanced for multi-agent LLM integration with Bedrock*
