
# ğŸ§ª Practical 5 â€“ Secure Logging with Morgan

This lab demonstrates how to apply **secure logging** practices in an `Express.js` application using **Morgan** and **rotating-file-stream**.

---

## âœ… Objectives

- âœ… Apply **Morgan** for logging
- âœ… Create **custom tokens**
- âœ… Log entries to a **rotating file**
- âœ… Log **exception errors** in structured **JSON** format

---

## ğŸ“¦ Setup Instructions

1. **Download and unzip** the project files.
2. Navigate to the `firstExpressServer/` directory.
3. Install dependencies:

```bash
npm install
npm install morgan rotating-file-stream
```

---

## ğŸ”§ Step-by-Step Instructions

### ğŸ”¹ Step 1: Console Logging with Morgan

In `controller/app.js`, add:

```javascript
const morgan = require('morgan');
app.use(morgan('combined'));
```

ğŸ‘‰ Run the server and observe **Apache-style logs** in the terminal.

---

### ğŸ”¹ Step 2: Apply Rotating Log File

Import modules:

```javascript
const fs = require('fs');
const path = require('path');
const rfs = require('rotating-file-stream');
```

Configure rotating log:

```javascript
const logDirectory = path.join(__dirname, '..', 'log');
if (!fs.existsSync(logDirectory)) {
    fs.mkdirSync(logDirectory);
}
const accessLogStream = rfs.createStream('log.txt', {
    interval: '12h',
    path: logDirectory,
});

app.use(morgan('combined', { stream: accessLogStream }));
```

---

### ğŸ”¹ Step 3: Create a Custom Token

```javascript
morgan.token('exception', (req, res) => res.locals.errorMessage || '-');
```

---

### ğŸ”¹ Step 4: Define a Custom JSON Format

```javascript
morgan.format('jsonFormat', (tokens, req, res) => {
    return JSON.stringify({
        exception: tokens.exception(req, res),
        method: req.method,
        url: req.originalUrl,
        ip: req.ip,
        date: new Date().toUTCString()
    });
});
```

Apply format:

```javascript
app.use(morgan('jsonFormat', { stream: accessLogStream }));
app.use(morgan('jsonFormat'));
```

---

### ğŸ”¹ Step 5: Log Exceptions in Routes

In any route handler (e.g., `/user`):

```javascript
res.locals.errorMessage = err.toString();
```

---

### ğŸ”¹ Step 6: Simulate an Exception

In `model/databaseConfig.js`, intentionally misconfigure credentials:

```javascript
user: 'root12' // ğŸš« Invalid user
```

ğŸ‘‰ Access `/user` and verify that logs are stored in `log/log.txt`.

---

## ğŸ“ Example Log Output

**âœ… Without Exception**:
```json
{"exception":"-","method":"GET","url":"/user","ip":"::1","date":"Tue, 06 Oct 2020 06:32:10 GMT"}
```

**âš ï¸ With Exception**:
```json
{"exception":"Error: ER_ACCESS_DENIED_ERROR: Access denied for user 'root12'@'localhost'","method":"GET","url":"/user","ip":"::1","date":"Tue, 06 Oct 2020 06:38:34 GMT"}
```

---

## âœ… Test Your Application

- Run using: `node server.js`
- Access:
  - `http://localhost:3000/user`
  - `http://localhost:3000/user/:id`
- Check `log/log.txt` for structured JSON log entries.

---

## ğŸ“ Learning Points

| Topic | Description |
|-------|-------------|
| **Middleware** | Apply and configure logging middleware. |
| **Logging** | Understand file vs console logging. |
| **Morgan** | Customize tokens and formats. |
| **Error Handling** | Capture runtime errors for auditing. |
| **Filesystem** | Cross-platform directory creation and use. |
| **Security** | Avoid leaking sensitive logs improperly. |

---

## ğŸ› ï¸ Troubleshooting Tips

â— **Logs Not Showing Up**
- Ensure `log/` directory exists.
- Check file permissions.

â— **No Exception in Logs**
- Use `res.locals.errorMessage = err.toString();`
- Trigger real errors for testing.

â— **Morgan Not Logging**
- Must apply Morgan **after body parser**, before routes.

â— **Rotating Logs Not Working**
- Confirm:
  - `npm install rotating-file-stream`
  - Proper `interval` and `path` config.

â— **App Crashes on Startup**
- Double-check:
  - All required modules are installed
  - Paths are correct
- Use `console.log()` for debugging setup steps.

---

ğŸ **End of Practical 5**
